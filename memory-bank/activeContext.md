# HashiCorp Docs 翻訳ツール - アクティブコンテキスト

## 現在の作業の焦点

現在の主な焦点は、以下の機能強化と改善です：

1. **ファイル名の簡略化**
   - 冗長な接頭語 "developer.hashicorp.com-vault-docs" をファイル名から削除
   - URLのパス構造を維持しつつ、より簡潔なファイル名を生成

2. **大きなドキュメントの分割処理**
   - 見出し（H1, H2）ベースの分割戦略の実装
   - 最大5000文字のチャンクサイズでの処理
   - 分割されたチャンクの順次処理と結合

3. **ファイルパス生成ロジックの改善**
   - URLのパス構造をファイルシステムの構造として反映
   - 必要なディレクトリの自動作成
   - ファイル書き込み前のディレクトリ存在確認

## 最近の変更

### 1. ファイル名生成ロジックの修正 (2025/5/7)

```typescript
// 修正前
const urlParts = url.replace(/^https?:\/\//, '').split('/');
const filename = urlParts.join('-').replace(/[^\w.-]/g, '') + '_ja.md';

// 修正後
const urlObject = new URL(url);
let urlPath = urlObject.pathname;

// パス部分から不要な接頭語を除去
let relativePath = urlPath;
if (relativePath.startsWith('/vault/docs/')) {
  relativePath = relativePath.substring('/vault/docs/'.length);
}

// ファイル名として使用できる形式に変換
const baseFilename = relativePath.replace(/[^\w.\/-]/g, '');
```

### 2. 見出しベースの分割処理の実装 (2025/5/7)

新しい関数 `splitMarkdownByHeadings` を実装し、大きなMarkdownコンテンツを見出し（H1, H2）や段落に基づいて分割できるようにしました。この関数は以下の階層的な分割戦略を使用します：

1. まずH1見出しで分割
2. H1セクションが大きすぎる場合はH2見出しで分割
3. H2セクションも大きすぎる場合は段落で分割

### 3. ファイル書き込み前のディレクトリ作成処理の追加 (2025/5/7)

ファイル書き込み前に親ディレクトリが存在することを確認し、必要に応じて再帰的に作成する処理を追加しました：

```typescript
// ディレクトリが存在することを確認（親ディレクトリを再帰的に作成）
fs.mkdirSync(path.dirname(originalOutputFilePath), { recursive: true });
```

これにより、`ENOENT: no such file or directory` エラーが解消されました。

### 4. 翻訳関数の修正 (2025/5/7)

`translateEnglishMarkdownToJapanese` 関数を修正し、見出しベースの分割処理を組み込みました：

```typescript
async function translateEnglishMarkdownToJapanese(markdownContent: string): Promise<string> {
  // 見出しベースで分割（最大5000文字）
  const chunks = splitMarkdownByHeadings(markdownContent, 5000);
  
  let translatedContent = '';
  
  // 各チャンクを順次翻訳
  for (const chunk of chunks) {
    console.log(`Translating chunk (${chunk.length} characters)...`);
    const translatedChunk = await processTextWithOpenRouter(
      englishToJapanesePromptTemplate, 
      chunk, 
      'English Markdown to Japanese Translation'
    );
    
    // 翻訳結果を結合
    if (translatedContent.length > 0) {
      translatedContent += '\n\n' + translatedChunk;
    } else {
      translatedContent = translatedChunk;
    }
  }
  
  return translatedContent;
}
```

## 次のステップ

1. **翻訳品質の向上**
   - プロンプトテンプレートの最適化
   - より高性能なLLMモデルの検討
   - 翻訳禁止単語リストの拡充

2. **エラーハンドリングの強化**
   - より詳細なエラーメッセージ
   - 自動リトライ機能の実装
   - 部分的な失敗からの回復メカニズム

3. **パフォーマンスの最適化**
   - 並列処理の導入（複数URLの同時処理）
   - キャッシュ機構の検討
   - チャンクサイズの最適化

4. **ユーザーエクスペリエンスの改善**
   - 進捗表示の強化
   - 設定オプションの拡充
   - コマンドライン引数のサポート

## アクティブな決定と考慮事項

### 1. ファイル構造に関する決定

URLのパス構造をファイルシステムの構造として反映することを決定しました。これにより、元のドキュメント構造が保持され、関連ファイルがグループ化されます。ただし、この決定には以下の考慮事項があります：

- **長所**: 論理的な構造の保持、関連ファイルの整理
- **短所**: パス処理の複雑化、ファイルシステムの制限（パス長など）
- **代替案**: フラットなファイル構造、データベース保存

### 2. 分割戦略に関する決定

コンテンツを見出し（H1, H2）に基づいて分割することを決定しました。これにより、コンテンツの論理構造が保持され、翻訳品質が向上します。ただし、この決定には以下の考慮事項があります：

- **長所**: 論理的な構造の保持、翻訳の一貫性向上
- **短所**: 実装の複雑化、見出しがない場合の対応
- **代替案**: 固定サイズの分割、文単位の分割

### 3. 2段階処理に関する決定

HTMLを直接日本語Markdownに変換せず、英語Markdownを中間ステップとして使用することを決定しました。これにより、処理が分離され、原文の保存と参照が可能になります。ただし、この決定には以下の考慮事項があります：

- **長所**: 処理の分離による品質向上、原文の保存
- **短所**: 処理時間の増加、APIコールの増加
- **代替案**: HTMLから直接日本語Markdownへの変換

## 学びと洞察

### 1. ファイルパス生成の教訓

最初の実装では、URLからファイル名を生成する際に、URLのパス構造が考慮されていませんでした。これにより、ディレクトリ構造が正しく作成されず、`ENOENT: no such file or directory` エラーが発生しました。

この問題から、以下の教訓が得られました：
- ファイル操作前には常にディレクトリの存在を確認する
- URLのパス構造をファイルパスに変換する際は、適切なパス操作関数を使用する
- エラーメッセージを注意深く分析し、根本原因を特定する

### 2. コンテンツ分割の洞察

大きなドキュメントを処理する際、単純な文字数ベースの分割ではなく、コンテンツの論理構造に基づいた分割が重要であることがわかりました。これにより、以下の洞察が得られました：
- 見出しは文書の論理的な区切りとして有効
- 階層的な分割戦略（H1 → H2 → 段落）が効果的
- 分割と結合のバランスが翻訳品質に影響する

### 3. エラーハンドリングの重要性

ファイル操作やネットワークリクエストなどの外部依存処理では、適切なエラーハンドリングが不可欠であることが再確認されました。特に以下の点が重要です：
- try-catchブロックによる例外の捕捉
- 詳細なエラーメッセージのログ記録
- フォールバックメカニズムの提供
- ユーザーへの明確なフィードバック

## 重要なパターンと設計上の好み

1. **段階的処理**: 複雑なタスクを小さな段階に分割し、各段階の出力を次の段階の入力として使用する
2. **設定の外部化**: APIキー、モデル名、ファイルパスなどの設定を環境変数として外部化
3. **プロンプトとコードの分離**: プロンプトテンプレートを外部ファイルとして管理
4. **階層的な分割戦略**: コンテンツを論理構造に基づいて階層的に分割
5. **ディレクトリ構造の保持**: URLのパス構造をファイルシステムの構造として反映
6. **詳細なログ記録**: 各処理ステップの進捗と結果を詳細にログ記録
7. **堅牢なエラーハンドリング**: 各処理ステップでのエラーを適切に捕捉し処理
