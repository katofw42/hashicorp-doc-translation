# 高可用性

Vault は、複数の Vault サーバーを実行することで停止を防ぎ、高可用性（HA）モードで稼働できます。

# 設計概要

Vaultを高可用性（HA）にする主な設計目標は、水平的なスケーラビリティに影響を与えることなく、ダウンタイムを最小限に抑えることです。Vaultは、コンピューティング要件ではなく、ストレージバックエンドのI/O制限に依存しています。I/O制限に依存することで、HAアプローチが簡素化され、複雑な調整が回避されます。

Integrated Storageなどのストレージバックエンドは、Vaultを高可用性設定で実行できるようにする追加の調整機能を提供します。バックエンドでサポートされているため、Vaultは追加の設定なしで自動的に高可用性モードで実行されます。

高可用性モードで実行する場合、Vaultサーバーは**スタンバイ**と**アクティブ**の2つの状態になります。同じストレージバックエンドを共有する複数のVaultサーバーでは、任意の時点で単一のインスタンスのみがアクティブになります。すべてのスタンバイインスタンスはホットスタンバイに配置されます。

アクティブサーバーのみがすべてのリクエストを処理し、スタンバイサーバーはすべてのリクエストをアクティブなVaultサーバーにリダイレクトします。

一方、アクティブサーバーがシールされた状態、障害が発生した状態、またはネットワーク接続を失った場合、スタンバイのVaultサーバーの1つがアクティブインスタンスになります。

*アンシールド*されたVaultサーバーのみがスタンバイとして機能できることに注意してください。サーバーがシールされた状態の場合、スタンバイとして機能できません。シールされた状態のサーバーは、アクティブサーバーに障害が発生した場合でも、リクエストを処理できません。

# パフォーマンススタンバイノード（Enterprise）

パフォーマンススタンバイノードは、ユーザーやアプリケーションからの読み取り専用リクエストにサービスを提供します。読み取り専用リクエストとは、Vaultのストレージを変更しないリクエストのことです。Vaultは、これらの操作に対するサービス能力を迅速にスケールアップし、ほとんどのシナリオとKVやTransitなどのシークレットエンジンに対して、ほぼリニアなリクエスト/秒のスケーリングを提供します。トラフィックはパフォーマンススタンバイノード全体に分散されるため、クライアントはこれらのIOPSを水平方向にスケールアップし、高トラフィックのワークロードを制御できます。

パフォーマンススタンバイノードに、ストレージへの書き込みを必要とするリクエストが到着した場合、そのリクエストはアクティブサーバーに転送されます。読み取り専用リクエストは、パフォーマンススタンバイ上でローカルに処理されます。

従来のHAスタンバイと同様に、パフォーマンススタンバイノードは、アクティブノードがシールされた場合、障害が発生した場合、またはネットワーク接続を失った場合に、アクティブインスタンスになります。

# アクティブノードになること

HAの設定におけるアクティブノードは、HAロックを保持します。アクティブノードが利用不可能になるか、オペレーターが `vault operator step-down` を呼び出してノードを降格させると、クラスター内のすべてのノードがHAロックの獲得を試みます。最初にロックの獲得と保持に成功したノードが、新しいアクティブノードになります。

HAロック競争プロセスは、クラスターのHAストレージバックエンドに依存します。例えば、Raftの統合ストレージを使用する場合、Vaultは常に[Raftリーダー選挙](https://www.vaultproject.io/docs/internals/integrated-storage#leadership-elections)に勝利したノードにHAロックを与えます。

HAロックを取得した後、ノードはクラスターのアクティブノードとして正式に機能するために、以下の一連の就任ステップを実行します：

1. ローカルのVaultインスタンスをシールする。
2. シール設定を再読み込みする。
3. 必要に応じて、シールを移行する。
4. 暗号化キーを再読み込みする。
5. 新しいHA クラスター内TLS証明書を作成する。
6. アクティブノードとしての状態を示すエントリをストレージに書き込む。
7. ローカルのVaultインスタンスをアンシールする。
8. クラスター内の他のノードからの接続を受け入れ始める。

就任ステップを完了すると、新しいアクティブノードは新しいクライアントリクエストへの応答を開始します。

HAスタンバイノードは、2.5秒ごとにアクティブノードの更新を確認します。アクティブノードが変更されると、スタンバイノードは転送接続を更新し、新しいアクティブノードへの接続を開きます。接続は、新しいアクティブノードがクラスター内の他のノードからの接続を開始するまで失敗するため、スタンバイノードは5秒ごとにハートビートとして、または転送を必要とする新しいクライアントリクエストが到着するたびに接続を再試行します。

パフォーマンススタンバイが有効な場合、スタンバイノードはアクティブノードの更新時にパフォーマンススタンバイに昇格します。スタンバイノードは、レプリケートされたデータを受信するために、アクティブノードから証明書と鍵ペアを要求します。スタンバイノードがシールされ、必要なセットアップタスクを実行し、アンシール後のセットアップを完了すると、新しいクライアントリクエストに応答できるようになります。

チュートリアル

以下のチュートリアルを参照して詳細を学んでください：

- [統合ストレージを用いたVaultリファレンスアーキテクチャ](https://www.vaultproject.io/tutorials/day-one-raft/raft-reference-architecture)
- [統合ストレージを使用したVault HA クラスタ](https://www.vaultproject.io/tutorials/raft/raft-storage)
- [Consulを用いたVault高可用性](https://www.vaultproject.io/tutorials/day-one-consul/ha-with-consul)
- [パフォーマンススタンバイノード](https://www.vaultproject.io/tutorials/enterprise/performance-standbys)